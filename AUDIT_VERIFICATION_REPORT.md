# Audit Verification Report

## SECTION A — Trace the Exact Call Graph
1. **Entry handler:** `IPC.CHAT_SEND` in `src/main/main.ts:110-152` receives each submission, appends the user message to the conversation, fetches the API key, then calls `Intake.process`, which is the first decision point.
2. **Route determination:** Within `src/main/llm/intake.ts:41-138`, `heuristicRoute` (lines 41-52) classifies short/simple requests as `chat`, URLs as `browse`, research keywords as `research`, otherwise defers to `llmIntake` (lines 111-138) which calls Claude with `INTAKE_PROMPT` and parses the returned JSON.
3. **Route selection:** After `Intake.process` returns, the handler switches on `result.route` (`src/main/main.ts:132-145`). Depending on the route:  
   - `chat`: `handleChatRoute` (`src/main/main.ts:225-250`) immediately invokes `AnthropicClient.chat` with existing conversation messages and streams text to `CHAT_STREAM_TEXT`.  
   - `browse`: `handleBrowseRoute` (`src/main/main.ts:252-269`) instantiates `ToolLoop` and runs the browser tool loop until Claude stops issuing tools.  
   - `research`: `handleResearchRoute` (`src/main/main.ts:271-373`) publishes a planning progress message, constructs a `TaskSpec`, runs `ExecutorRunner`, gates evidence, loops synthesizer retries, and finally streams the final answer.
4. **First unit of work per route:** For `chat`, the unit is the LLM response triggered by `AnthropicClient.chat` (`src/main/main.ts:225-246`); for `browse`, it is the `ToolLoop.run` invocation (`src/main/main.ts:252-269`); for research, it is the `TaskSpec` validated in `Intake` (`src/main/llm/intake.ts:142-197`) and the progress publication with `phase: 'intake'` (`src/main/main.ts:281-287`).

## SECTION B — Input Context Provenance
- `Intake.process` receives only the latest user message: the handler passes `content` (`src/main/main.ts:118-145`), and `llmIntake` builds `messages` as `[ { id: 'user-1', role: 'user', content: userMessage, createdAt: new Date().toISOString() } ]` (`src/main/llm/intake.ts:112-120`). No prior assistant or tool output is included.
- The exact text sent to the planner LLM is the concatenation of that single-message array and the `INTAKE_PROMPT` constant defined in the same file (`src/main/llm/intake.ts:54-95`), so the planner sees only the user query plus the explicit routing instructions and schema requirements.
- Metadata included in the payload is restricted to the generated message `id`, role, content, and timestamp; there are no conversation slices, tool logs, or system context added before `Intake` invokes the LLM (`src/main/llm/intake.ts:112-138`).

## SECTION C — TaskSpec Constraints (Actual, Not Intended)
| Constraint | Value / Behavior | Enforcement Location | Behavior When Exceeded / Missing |
|---|---|---|---|
| Actions capped | 5 actions maximum; extra entries discarded after deduplication | `src/main/llm/intake.ts:164-197` (`validateTaskSpec` and slicing at line 175) | Extra actions are silently dropped when `mergedActions.slice(0, 5)` runs (line 175). |
| Budget caps | `maxActions: 10`, `maxBatches: 3`, `maxTimeSeconds: 60` | `TaskSpec` hardcoded in `validateTaskSpec` (`src/main/llm/intake.ts:187-195`) and enforced inside `ExecutorRunner` loop (`src/main/executor/runner.ts:178-207`). | Loop breaks when budgets hit (lines 178-207) and remaining actions are skipped with `phase: 'executing'` messages (`src/main/executor/runner.ts:333-355`). |
| Per-search visits | `MAX_SOURCES_PER_SEARCH = 3`; only the first three harvested links are followed | `src/main/executor/actions.ts:25-27` and `219-227` | Additional links beyond the first three are ignored inside `executeSearch`; no fallback within the same action. |
| Retry attempts | Synthesizer retries up to 2 times, driven by `Synthesizer.MAX_RETRIES = 2` | `src/main/llm/synthesizer.ts:56-149` and the retry loop in `handleResearchRoute` (`src/main/main.ts:338-366`) | After two retries the synthesizer error propagates and the research route aborts. |
| Fallback search | If no actions are provided, a Google search for the user goal is inserted | `src/main/llm/intake.ts:164-173` | The fallback action becomes the only pending action. |
| Targeted query injection | For inputs mentioning “OpenClaw”, `TARGETED_DOC_QUERIES` (two canonical searches) are prepended with `priority: 0` | `src/main/llm/intake.ts:12-15` and `200-233` (`withTargetedSearches`) | Those targeted searches run before heuristics-derived actions and are deduplicated via `seenKeys`. |

## SECTION D — Execution Loop Semantics
- **Pending action selection:** `ExecutorRunner` repeatedly calls `getNextBatch` (`src/main/executor/runner.ts:359-363`), which returns all pending actions with the lowest `priority` value, then caps them to the browser pool capacity (`runner.ts:199-207`) and budget left (`runner.ts:204-207`).
- **Concurrency:** The code instantiates `BrowserPool` with `maxSize = 1` and `useSharedView = true` (`src/main/main.ts:276-279`), and the pool constructor honours that by limiting capacity and reusing a single `BrowserView` (`src/main/browser/pool.ts:3-88`). Thus no parallel BrowserViews can run simultaneously in this build.
- **Tabs vs views:** UI tabs derive solely from `ResearchProgress` payloads (`renderer/main.ts:291-398`), which renders previews produced by `ExecutorRunner` without any direct link to concurrent BrowserViews; all “tab” data arrives after serialized actions finish (`src/main/executor/runner.ts:226-277`), so tabs reflect serialized previews, not simultaneous views.
- **Loop termination:** The while loop breaks when budgets/time limits hit (`runner.ts:178-207`), when the heartbeat returns `{ action: 'done' }` (`runner.ts:304-330`), or when `stop()` is invoked (`runner.ts:152-154`). Pending actions are then reported as skipped (`runner.ts:333-355`), so work beyond the budget is surfaced through progress messages but not executed.

## SECTION E — Evidence Eligibility + Coverage Math
- **Eligibility for synthesis:** `eligibleForSynthesis` returns `true` only when `sourceKind` is `official_docs`, `repo_canonical`, or `content_primary` with tier `A` or `B` (`src/main/executor/authority.ts:51-56`).
- **Primary sources:** `eligibleForPrimaryClaims` returns `true` when `sourceKind` is `official_docs` or `repo_canonical` (`src/main/executor/authority.ts:58-60`).
- **Distinct hosts:** `evaluateEvidenceGate` normalizes hosts via `normalizeHost` (`src/main/executor/authority.ts:15-22`) and builds a deduplicated array before counting (`authority.ts:68-95`).
- **Coverage thresholds:** `Summarizer.buildCheckpoint` checks each criterion by counting how often words longer than 3 characters appear in collected evidence and declares it covered when hits ≥ 0.4×word count (`src/main/executor/summarizer.ts:37-63`). The synthesizer repeats the same 40 % threshold on the final answer text (`src/main/llm/synthesizer.ts:150-165`).
- **Shallow evidence passes:** Because the coverage simply checks for keyword presence (`summarizer.ts:37-46`), a short snippet that includes the same criterion words (even without context) triggers coverage. Thus shallow evidence containing the criterion keywords suffices to mark it covered, and Claude can cite that evidence in synthesis (`synthesizer.ts:117-140`).

## SECTION F — Failure Handling Truth Table
| Failure condition | User-visible outcome | Execution continuation | Implementation reference |
|---|---|---|---|
| Navigation timeout (e.g., page load takes > timeout) | `ResearchProgress` shows `✗ <source>: failed` and action marked `error` (logging present) | Loop continues with next `batchResults`; action logged but the action’s evidence is absent | Timeout enforced by `navigateWithTimeout` (`src/main/executor/actions.ts:365-384`); error handling in `execute` (`actions.ts:99-137`) and progress update in `runner.ts:256-277`. |
| `maxActions` reached | No further actions run; pending actions reported as skipped with `reason: skipped_budget` | Loop breaks; remaining actions are reported but not executed (`phase: 'executing'` messages) | Budget check and break at `runner.ts:186-207`; skipped reporting at `runner.ts:333-355`. |
| Evidence gate failure after execution | UI shows two checkpoint messages (gate blocked + done) and final error thrown | Execution halts; research route throws and `IPC_EVENTS.CHAT_ERROR` surfaces | Gate evaluation in `src/main/executor/authority.ts:68-95`; handling and progress broadcast in `src/main/main.ts:295-335`. |
| Synthesizer missing citations | UI receives `ResearchProgress` checkpoint messaging “Synthesizer missing citations… retrying” (up to 2 retries); final exception if still missing | Execution retries synthesis twice (`Synthesizer.MAX_RETRIES`) then aborts, propagating error | `Synthesizer` enforces citations and throws `SynthesizerError` at `src/main/llm/synthesizer.ts:123-149`; retry loop in `src/main/main.ts:338-366`. |
| Content extraction failure | Action marked `error`, progress message `✗ <source>: failed`, preview still shown but no evidence | Execution continues; missing evidence simply reduces covered sources | `visitSourcePage` catch builds fallback preview (`src/main/executor/actions.ts:254-288`); `ActionResult.status` set to `'error'` in `execute` (`actions.ts:99-137`); `ExecutorRunner` renders failure message (`runner.ts:256-277`). |
| Search SERP harvest failure | Action produces fallback preview/evidence or none, but `✗` message is shown; if no evidence, gate may reject | Loop continues; fallback evidence may arrive or not depending on extraction | Harvest failure caught in `executeSearch` try/catch (`actions.ts:160-187`); fallback evidence path returns early with previews (`actions.ts:186-232`). |

## SECTION G — UI Instrumentation Mapping
- **IPC events and payload shapes (from `preload.ts:1-91` and `renderer/main.ts:239-398`):** `CHAT_STREAM_TEXT`, `CHAT_STREAM_END`, `CHAT_TOOL_START`, `CHAT_TOOL_RESULT`, `CHAT_ERROR`, `RESEARCH_PROGRESS`, `BROWSER_*` controls, and browser state events. `onResearchProgress` payload includes `phase`, `message`, optional `actions`, `checkpointNumber`, `sources`, and `gateStatus` (`src/main/preload.ts:1-91`; `src/renderer/main.ts:291-398`).
- **Internal decisions emitted vs invisible:** Routes are selected entirely inside `Intake.process` and the main handler (`src/main/main.ts:118-145`), but no IPC event broadcasts the chosen route; the UI only sees the ensuing stream or progress. Heartbeat responses (`ExecutorRunner.heartbeat` in `runner.ts:459-483`) are consumed inside the executor and never emitted to the renderer, so the UI cannot directly observe heartbeat decisions. Skipped actions are emitted as `phase: 'executing'` messages with `status: 'pending'` and `reason: 'skipped_budget'` (`runner.ts:333-355`), so the UI only learns about skipped actions when the executor explicitly reports them.
- **Discarded sources emission:** When `ExecutorRunner` sends `actions` with `producedSources`, each source’s `discardReason` flows through to `ResearchProgress` (`runner.ts:256-277`), and the renderer renders them in the “Discarded sources” section only when `discardReason` is present (`src/renderer/main.ts:336-373`). On gate failure, `handleResearchRoute` additionally emits all previews via `sources` so discarded sources are visible there as well (`src/main/main.ts:309-329`). Thus discard information is emitted whenever produced sources include `discardReason`. 

## SECTION H — Gaps vs Build Summary (Factual Only)
1. **Planned Router/Planner/Executor pipeline missing:** The implementation prompt describes a Router class (`IMPLEMENTATION_PROMPT.md:1426-1480`) and a three-layer architecture, but the repository only contains `Intake` (`src/main/llm/intake.ts:41-197`) for routing/planning; there is no `Router` file or separate planning LLM before execution.
2. **Parallel browsers promised but not present:** The summary states that a browser pool should support 4 parallel headless views (`IMPLEMENTATION_PROMPT.md:1173-1225`), yet `handleResearchRoute` instantiates `new BrowserPool(win, 1, true)` (`src/main/main.ts:271-279`), so only one shared BrowserView exists.
3. **Executor still uses Claude for heartbeat/synthesis:** The build summary claims the executor should run “without LLM” (`IMPLEMENTATION_PROMPT.md:1193-1219`), but `ExecutorRunner` still invokes Claude for heartbeat decisions and the synthesizer streams `CHAT_STREAM_TEXT` while enforcing citation rules (`src/main/executor/runner.ts:459-483`; `src/main/llm/synthesizer.ts:64-210`).
